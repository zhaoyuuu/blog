# ä»£ç†åŸºç¡€

éš¾åº¦ï¼šâ­ï¸â­ï¸â­ï¸â­ï¸

ECMAScript 6 æ–°å¢çš„**ä»£ç†å’Œåå°„**ä¸ºå¼€å‘è€…æä¾›äº†**æ‹¦æˆªå¹¶å‘åŸºæœ¬æ“ä½œåµŒå…¥é¢å¤–è¡Œä¸º**çš„èƒ½åŠ›ã€‚å…·ä½“åœ°è¯´ï¼Œå¯ä»¥ç»™ç›®æ ‡å¯¹è±¡å®šä¹‰ä¸€ä¸ªå…³è”çš„**ä»£ç†å¯¹è±¡**ï¼Œè€Œè¿™ä¸ªä»£ç†å¯¹è±¡å¯ä»¥ä½œä¸ºæŠ½è±¡çš„ç›®æ ‡å¯¹è±¡æ¥ä½¿ç”¨ã€‚åœ¨å¯¹ç›®æ ‡å¯¹è±¡çš„å„ç§æ“ä½œ**å½±å“ç›®æ ‡å¯¹è±¡ä¹‹å‰**ï¼Œå¯ä»¥**åœ¨ä»£ç†å¯¹è±¡ä¸­å¯¹è¿™äº›æ“ä½œåŠ ä»¥æ§åˆ¶**ã€‚

> ğŸ’Œ å¯¹åˆšåˆšæ¥è§¦è¿™ä¸ªä¸»é¢˜çš„å¼€å‘è€…è€Œè¨€ï¼Œä»£ç†æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„æ¦‚å¿µï¼Œè€Œä¸”è¿˜å¤¹æ‚ç€å¾ˆå¤šæ–°æœ¯è¯­ã€‚ä½†å…¶å®åªè¦çœ‹å‡ ä¸ªä¾‹å­ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚

## åˆ›å»ºç©ºä»£ç†

ä»£ç†æ˜¯ä½¿ç”¨ `Proxy` æ„é€ å‡½æ•°åˆ›å»ºçš„ã€‚è¿™ä¸ªæ„é€ å‡½æ•°æ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼š**ç›®æ ‡å¯¹è±¡**å’Œ**å¤„ç†ç¨‹åºå¯¹è±¡**ã€‚ç¼ºå°‘å…¶ä¸­ä»»ä½•ä¸€ä¸ªå‚æ•°éƒ½ä¼šæŠ›å‡º TypeErrorã€‚

å¦‚ä¸‹é¢çš„ä»£ç æ‰€ç¤ºï¼Œåœ¨ä»£ç†å¯¹è±¡ä¸Šæ‰§è¡Œçš„**ä»»ä½•æ“ä½œ**å®é™…ä¸Š**éƒ½ä¼šåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡**ã€‚å”¯ä¸€å¯æ„ŸçŸ¥çš„ä¸åŒå°±æ˜¯ä»£ç ä¸­æ“ä½œçš„æ˜¯ä»£ç†å¯¹è±¡ï¼š

```js
const target = {
  id: 'target',
}
const handler = {}
const proxy = new Proxy(target, handler)

// id å±æ€§ä¼šè®¿é—®åŒä¸€ä¸ªå€¼
console.log(target.id) // target
console.log(proxy.id) // target
// ç»™ç›®æ ‡å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºä¸¤ä¸ªå¯¹è±¡è®¿é—®çš„æ˜¯åŒä¸€ä¸ªå€¼
target.id = 'foo'
console.log(target.id) // foo
console.log(proxy.id) // foo
// ç»™ä»£ç†å±æ€§èµ‹å€¼ä¼šåæ˜ åœ¨ä¸¤ä¸ªå¯¹è±¡ä¸Š
// å› ä¸ºè¿™ä¸ªèµ‹å€¼ä¼šè½¬ç§»åˆ°ç›®æ ‡å¯¹è±¡
proxy.id = 'bar'
console.log(target.id) // bar
console.log(proxy.id) // bar
// hasOwnProperty()æ–¹æ³•åœ¨ä¸¤ä¸ªåœ°æ–¹
// éƒ½ä¼šåº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡
console.log(target.hasOwnProperty('id')) // true
console.log(proxy.hasOwnProperty('id')) // true
// Proxy.prototype æ˜¯ undefined
// å› æ­¤ä¸èƒ½ä½¿ç”¨ instanceof æ“ä½œç¬¦
console.log(target instanceof Proxy) // TypeError: Function has non-object prototype 'undefined' in instanceof check
console.log(proxy instanceof Proxy) // TypeError: Function has non-object prototype 'undefined' in instanceof check
// ä¸¥æ ¼ç›¸ç­‰å¯ä»¥ç”¨æ¥åŒºåˆ†ä»£ç†å’Œç›®æ ‡
console.log(target === proxy) // false
```

## å®šä¹‰æ•è·å™¨

**ä½¿ç”¨ä»£ç†çš„ä¸»è¦ç›®çš„æ˜¯å¯ä»¥å®šä¹‰æ•è·å™¨ï¼ˆ`trap`ï¼‰ã€‚** æ•è·å™¨å°±æ˜¯åœ¨**å¤„ç†ç¨‹åºå¯¹è±¡(handler)** ä¸­å®šä¹‰çš„â€œ**åŸºæœ¬æ“ä½œçš„æ‹¦æˆªå™¨**â€ã€‚æ¯ä¸ªå¤„ç†ç¨‹åºå¯¹è±¡å¯ä»¥åŒ…å«é›¶ä¸ªæˆ–å¤šä¸ªæ•è·å™¨ï¼Œæ¯ä¸ªæ•è·å™¨éƒ½å¯¹åº”ä¸€ç§åŸºæœ¬æ“ä½œï¼Œå¯ä»¥ç›´æ¥æˆ–é—´æ¥åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨ã€‚æ¯æ¬¡åœ¨ä»£ç†å¯¹è±¡ä¸Šè°ƒç”¨è¿™äº›åŸºæœ¬æ“ä½œæ—¶ï¼Œä»£ç†å¯ä»¥åœ¨è¿™äº›æ“ä½œä¼ æ’­åˆ°ç›®æ ‡å¯¹è±¡ä¹‹å‰å…ˆè°ƒç”¨æ•è·å™¨å‡½æ•°ï¼Œä»è€Œ**æ‹¦æˆªå¹¶ä¿®æ”¹ç›¸åº”çš„è¡Œä¸º**ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢å®šä¹‰äº†ä¸€ä¸ª `get()` æ•è·å™¨ï¼š

```js{5-8}
const target = {
  foo: 'bar',
}
const handler = {
  // æ•è·å™¨åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­ä»¥æ–¹æ³•åä¸ºé”®
  get() {
    return 'handler override'
  },
}
const proxy = new Proxy(target, handler);
```

è¿™æ ·ï¼Œå½“é€šè¿‡ä»£ç†å¯¹è±¡æ‰§è¡Œ `get()` æ“ä½œæ—¶ï¼Œå°±ä¼šè§¦å‘å®šä¹‰çš„ `get()` æ•è·å™¨ï¼š

```js{12,14,16}
const target = {
  foo: 'bar',
}
const handler = {
  // æ•è·å™¨åœ¨å¤„ç†ç¨‹åºå¯¹è±¡ä¸­ä»¥æ–¹æ³•åä¸ºé”®
  get() {
    return 'handler override'
  },
}
const proxy = new Proxy(target, handler)
console.log(target.foo) // bar
console.log(proxy.foo) // handler override
console.log(target['foo']) // bar
console.log(proxy['foo']) // handler override
console.log(Object.create(target)['foo']) // bar
console.log(Object.create(proxy)['foo']) // handler override
```

## æ•è·å™¨å‚æ•°å’Œ Reflect API

æ‰€æœ‰æ•è·å™¨éƒ½å¯ä»¥è®¿é—®ç›¸åº”çš„å‚æ•°ï¼ŒåŸºäºè¿™äº›å‚æ•°å¯ä»¥**é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸º**ã€‚æ¯”å¦‚ï¼Œ`get()` æ•è·å™¨ä¼šæ¥æ”¶åˆ°**ç›®æ ‡å¯¹è±¡**ã€**è¦æŸ¥è¯¢çš„å±æ€§**å’Œ**ä»£ç†å¯¹è±¡**ä¸‰ä¸ªå‚æ•°ï¼š

```js{5,12-15}
const target = {
  foo: 'bar',
}
const handler = {
  get(trapTarget, property, receiver) {
    console.log(trapTarget === target)
    console.log(property)
    console.log(receiver === proxy)
  },
}
const proxy = new Proxy(target, handler)
proxy.foo
// true
// foo
// true
```

æœ‰äº†è¿™äº›å‚æ•°ï¼Œå°±å¯ä»¥é‡å»ºè¢«æ•è·æ–¹æ³•çš„åŸå§‹è¡Œä¸ºï¼š

```js{5-7}
const target = {
  foo: 'bar',
}
const handler = {
  get(trapTarget, property, receiver) {
    return trapTarget[property]
  },
}
const proxy = new Proxy(target, handler)
console.log(proxy.foo) // bar
console.log(target.foo) // bar
```

æ‰€æœ‰æ•è·å™¨éƒ½å¯ä»¥åŸºäºè‡ªå·±çš„å‚æ•°é‡å»ºåŸå§‹æ“ä½œï¼Œä½†å¹¶éæ‰€æœ‰æ•è·å™¨è¡Œä¸ºéƒ½åƒ `get()` é‚£ä¹ˆç®€å•ã€‚å› æ­¤ï¼Œé€šè¿‡æ‰‹åŠ¨å†™ç å¦‚æ³•ç‚®åˆ¶çš„æƒ³æ³•æ˜¯ä¸ç°å®çš„ ğŸ¤” ã€‚<br>
å®é™…ä¸Šï¼Œå¼€å‘è€…å¹¶ä¸éœ€è¦æ‰‹åŠ¨é‡å»ºåŸå§‹è¡Œä¸ºï¼Œè€Œæ˜¯**å¯ä»¥é€šè¿‡è°ƒç”¨å…¨å±€ Reflect å¯¹è±¡ä¸Šï¼ˆå°è£…äº†åŸå§‹è¡Œä¸ºï¼‰çš„åŒåæ–¹æ³•æ¥è½»æ¾é‡å»º**ğŸ¤— ã€‚

**å¤„ç†ç¨‹åºå¯¹è±¡ä¸­æ‰€æœ‰å¯ä»¥æ•è·çš„æ–¹æ³•éƒ½æœ‰å¯¹åº”çš„ Reflect API æ–¹æ³•ã€‚** è¿™äº›æ–¹æ³•ä¸æ•è·å™¨æ‹¦æˆªçš„æ–¹æ³•å…·æœ‰ç›¸åŒçš„åç§°å’Œå‡½æ•°ç­¾åï¼Œè€Œä¸”ä¹Ÿå…·æœ‰ä¸è¢«æ‹¦æˆªæ–¹æ³•ç›¸åŒçš„è¡Œä¸ºã€‚å› æ­¤ï¼Œä½¿ç”¨ Reflect API ä¹Ÿå¯ä»¥åƒä¸‹é¢è¿™æ ·å®šä¹‰å‡ºç©ºä»£ç†å¯¹è±¡ï¼š

```js{6}
const target = {
  foo: 'bar',
}
const handler = {
  get() {
    return Reflect.get(...arguments)
  },
}
const proxy = new Proxy(target, handler)
console.log(proxy.foo) // bar
console.log(target.foo) // bar
```

ç”šè‡³è¿˜å¯ä»¥å†™å¾—æ›´ç®€æ´ä¸€äº›ï¼š

```js{2}
const handler = {
  get: Reflect.get
};
```

äº‹å®ä¸Šï¼Œå¦‚æœçœŸæƒ³åˆ›å»ºä¸€ä¸ªå¯ä»¥æ•è·æ‰€æœ‰æ–¹æ³•ï¼Œç„¶åå°†æ¯ä¸ªæ–¹æ³•è½¬å‘ç»™å¯¹åº” Reflect API çš„ç©ºä»£ç†ï¼Œé‚£ä¹ˆç”šè‡³ä¸éœ€è¦å®šä¹‰å¤„ç†ç¨‹åºå¯¹è±¡ï¼š

```js{4}
const target = {
  foo: 'bar',
}
const proxy = new Proxy(target, Reflect)
console.log(proxy.foo) // bar
console.log(target.foo) // bar
```

Reflect API ä¸ºå¼€å‘è€…å‡†å¤‡å¥½äº†**æ ·æ¿ä»£ç **ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šå¼€å‘è€…å¯ä»¥ç”¨**æœ€å°‘çš„ä»£ç ä¿®æ”¹æ•è·çš„æ–¹æ³•**ã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ä»£ç åœ¨æŸä¸ªå±æ€§è¢«è®¿é—®æ—¶ï¼Œä¼šå¯¹è¿”å›çš„å€¼è¿›è¡Œä¸€ç•ªä¿®é¥°ï¼š

```js{15}
const target = {
  foo: 'bar',
  baz: 'qux',
}
const handler = {
  get(trapTarget, property, receiver) {
    let decoration = ''
    if (property === 'foo') {
      decoration = '!!!'
    }
    return Reflect.get(...arguments) + decoration
  },
}
const proxy = new Proxy(target, handler)
console.log(proxy.foo) // bar!!!
console.log(target.foo) // bar
console.log(proxy.baz) // qux
console.log(target.baz) // qux
```

## æ•è·å™¨ä¸å˜å¼

ä½¿ç”¨æ•è·å™¨å‡ ä¹å¯ä»¥æ”¹å˜æ‰€æœ‰åŸºæœ¬æ–¹æ³•çš„è¡Œä¸ºï¼Œä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰é™åˆ¶ã€‚**æ•è·å¤„ç†ç¨‹åºçš„è¡Œä¸ºå¿…é¡»éµå¾ªâ€œæ•è·å™¨ä¸å˜å¼â€ï¼ˆtrap invariantï¼‰**ã€‚æ•è·å™¨ä¸å˜å¼å› æ–¹æ³•ä¸åŒè€Œå¼‚ï¼Œä½†é€šå¸¸éƒ½ä¼šé˜²æ­¢æ•è·å™¨å®šä¹‰å‡ºç°è¿‡äºåå¸¸çš„è¡Œä¸ºã€‚
æ¯”å¦‚ï¼Œå¦‚æœç›®æ ‡å¯¹è±¡æœ‰ä¸€ä¸ªä¸å¯é…ç½®ä¸”ä¸å¯å†™çš„æ•°æ®å±æ€§ï¼Œé‚£ä¹ˆåœ¨æ•è·å™¨è¿”å›ä¸€ä¸ªä¸è¯¥å±æ€§ä¸åŒçš„å€¼æ—¶ï¼Œä¼šæŠ›å‡º TypeErrorï¼š

```js{4,8-10,14}
const target = {}
Object.defineProperty(target, 'foo', {
  configurable: false,
  writable: false,
  value: 'bar',
})
const handler = {
  get() {
    return 'qux'
  },
}
const proxy = new Proxy(target, handler)
console.log(proxy.foo)
// TypeError
```

## å¯æ’¤é”€ä»£ç†

å¯¹äºä½¿ç”¨ `new Proxy()` åˆ›å»ºçš„æ™®é€šä»£ç†æ¥è¯´ï¼Œè¿™ç§è”ç³»ä¼šåœ¨ä»£ç†å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå†…ä¸€ç›´æŒç»­å­˜åœ¨ã€‚**ä½†æ˜¯æœ‰æ—¶å€™å¯èƒ½éœ€è¦ä¸­æ–­ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡ä¹‹é—´çš„è”ç³»ã€‚** Proxy ä¹Ÿæš´éœ²äº† **`revocable()`** æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ”¯æŒ**æ’¤é”€ä»£ç†å¯¹è±¡ä¸ç›®æ ‡å¯¹è±¡çš„å…³è”**ã€‚æ’¤é”€ä»£ç†çš„æ“ä½œæ˜¯ä¸å¯é€†çš„ã€‚è€Œä¸”ï¼Œæ’¤é”€å‡½æ•°ï¼ˆ`revoke()`ï¼‰æ˜¯å¹‚ç­‰çš„ï¼Œè°ƒç”¨å¤šå°‘æ¬¡çš„ç»“æœéƒ½ä¸€æ ·ã€‚æ’¤é”€ä»£ç†ä¹‹åå†è°ƒç”¨ä»£ç†ä¼šæŠ›å‡º TypeErrorã€‚

**ä»£ç†å¯¹è±¡**å’Œ**æ’¤é”€å‡½æ•°**æ˜¯åœ¨å®ä¾‹åŒ–æ—¶åŒæ—¶ç”Ÿæˆçš„ï¼š

```js{9,13}
const target = {
  foo: 'bar',
}
const handler = {
  get() {
    return 'intercepted'
  },
}
const { proxy, revoke } = Proxy.revocable(target, handler)
console.log(proxy.foo) // intercepted
console.log(target.foo) // bar
revoke()
console.log(proxy.foo) // TypeError
```

## å®ç”¨ Reflect API

æŸäº›æƒ…å†µä¸‹åº”è¯¥ä¼˜å…ˆä½¿ç”¨ Reflect APIï¼Œè¿™æ˜¯æœ‰ä¸€äº›ç†ç”±çš„ã€‚

**_1. Reflect API ä¸å¯¹è±¡ API_**

åœ¨ä½¿ç”¨ Reflect API æ—¶ï¼Œè¦è®°ä½ï¼š

- Reflect API å¹¶**ä¸é™äºæ•è·å¤„ç†ç¨‹åº**
- å¤§å¤šæ•° Reflect API æ–¹æ³•åœ¨ Object ç±»å‹ä¸Š**æœ‰å¯¹åº”çš„æ–¹æ³•**

> é€šå¸¸ï¼ŒObject ä¸Šçš„æ–¹æ³•é€‚ç”¨äºé€šç”¨ç¨‹åºï¼Œè€Œåå°„æ–¹æ³•é€‚ç”¨äºç»†ç²’åº¦çš„å¯¹è±¡æ§åˆ¶ä¸æ“ä½œã€‚

**_2. çŠ¶æ€æ ‡è®°_**

å¾ˆå¤šåå°„æ–¹æ³•è¿”å›ç§°ä½œâ€œ**çŠ¶æ€æ ‡è®°**â€çš„**å¸ƒå°”å€¼**ï¼Œè¡¨ç¤ºæ„å›¾æ‰§è¡Œçš„æ“ä½œæ˜¯å¦æˆåŠŸã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ Reflect API å¯¹ä¸‹é¢çš„ä»£ç è¿›è¡Œé‡æ„ï¼š

```js
// åˆå§‹ä»£ç 
const o = {}
try {
  Object.defineProperty(o, 'foo', 'bar')
  console.log('success')
} catch (e) {
  console.log('failure')
}
```

åœ¨å®šä¹‰æ–°å±æ€§æ—¶å¦‚æœå‘ç”Ÿé—®é¢˜ï¼Œ`Reflect.defineProperty()` ä¼šè¿”å› falseï¼Œè€Œä¸æ˜¯æŠ›å‡ºé”™è¯¯ï¼š

```js
// é‡æ„åçš„ä»£ç 
const o = {}
if (Reflect.defineProperty(o, 'foo', { value: 'bar' })) {
  console.log('success')
} else {
  console.log('failure')
}
```

ä»¥ä¸‹åå°„æ–¹æ³•éƒ½ä¼šæä¾›çŠ¶æ€æ ‡è®°ï¼š

- `Reflect.defineProperty()`
- `Reflect.preventExtensions()`
- `Reflect.setPrototypeOf()`
- `Reflect.set()`
- `Reflect.deleteProperty()`

## ä»£ç†å¦ä¸€ä¸ªä»£ç†

ä»£ç†å¯ä»¥æ‹¦æˆª Reflect API çš„æ“ä½œï¼Œè€Œè¿™æ„å‘³ç€å®Œå…¨å¯ä»¥åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œé€šè¿‡å®ƒå»ä»£ç†å¦ä¸€ä¸ªä»£ç†ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ä¸€ä¸ªç›®æ ‡å¯¹è±¡ä¹‹ä¸Š**æ„å»ºå¤šå±‚æ‹¦æˆªç½‘**ï¼š

```js
const target = {
  foo: 'bar',
}
const firstProxy = new Proxy(target, {
  get() {
    console.log('first proxy')
    return Reflect.get(...arguments)
  },
})
const secondProxy = new Proxy(firstProxy, {
  get() {
    console.log('second proxy')
    return Reflect.get(...arguments)
  },
})
console.log(secondProxy.foo)
// second proxy
// first proxy
// bar
```
